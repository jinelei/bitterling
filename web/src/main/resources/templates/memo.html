<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="备忘"></title>
    <link rel="icon" th:href="@{/favicon.ico}" type="image/x-icon">
    <script th:src="@{/js/tailwind.min.js}"></script>
    <script th:src="@{/js/root.js}"></script>
    <link th:href="@{/css/font-awesome.min.css}" rel="stylesheet">
    <link th:href="@{/css/root.css}" rel="stylesheet">
</head>
<body>

<th:block th:replace="~{layout/base :: navbar('memo')}"></th:block>

<main class="flex-grow container mx-auto py-6 p-3">
    <!-- 左侧标签列表栏 -->
    <aside class="w-64 bg-white sidebar-shadow h-screen sticky top-0 flex flex-col hidden md:block">
        <!-- 标签列表 -->
        <div class="flex-grow overflow-y-auto p-4">
            <ul id="tagList" class="space-y-2">
                <li th:each="tag : ${tagList}" class="border-b border-gray-200">
                    <a th:href="@{/tag/{id}(id=${tag.id})}"
                       class="tag-btn w-full flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 transition-all">
                        <i th:class="'fa mr-2 ' + ${tag.icon}"></i>
                        <span th:text="${tag.name}"></span>
                        <span th:text="${tag.count}"
                              class="bg-primary/20 rounded-full w-6 h-6 flex items-center justify-center text-xs">0</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- 左侧底部新增标签提示 -->
        <div class="p-4 border-t border-gray-100 text-sm text-gray-500">
            <p><i class="fa fa-info-circle mr-2"></i> 选择标签分类备忘录</p>
        </div>
    </aside>

    <!-- 右侧主内容区（备忘录列表+操作区） -->
    <main class="flex-grow overflow-y-auto">
        <!-- 顶部导航栏 -->
        <header class="bg-white card-shadow sticky top-0 z-10 px-6 py-4">
            <div class="flex flex-col sm:flex-row gap-4 items-center justify-between">
                <h1 class="text-[clamp(1.25rem,3vw,1.75rem)] font-bold text-primary flex items-center">
                    <i class="fa fa-sticky-note-o mr-2"></i>
                    我的备忘录
                </h1>

                <!-- 搜索栏 -->
                <div class="relative w-full sm:w-96">
                    <input
                            type="text"
                            id="searchInput"
                            placeholder="输入关键词查询备忘录..."
                            class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                    >
                    <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>

                <!-- 操作按钮组 -->
                <div class="flex gap-3">
                    <button id="resetBtn"
                            class="bg-gray-200 hover:bg-gray-300 text-dark px-4 py-2 rounded-lg transition-all duration-300 text-sm">
                        <i class="fa fa-refresh mr-1"></i>重置
                    </button>
                    <button id="addMemoBtn"
                            class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all duration-300 text-sm">
                        <i class="fa fa-plus mr-1"></i>新增
                    </button>
                </div>
            </div>
        </header>

        <!-- 新增/编辑备忘录表单（默认隐藏，内嵌在右侧页面） -->
        <div id="memoFormContainer" class="bg-white card-shadow mx-6 my-4 p-6 rounded-lg hidden">
            <h2 id="formTitle" class="text-xl font-bold text-dark mb-6">新增备忘录</h2>
            <form id="memoForm">
                <input type="hidden" id="memoId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="memoTitle" class="block text-sm font-medium text-gray-700 mb-2">标题 <span
                                class="text-danger">*</span></label>
                        <input
                                type="text"
                                id="memoTitle"
                                class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                                placeholder="请输入备忘录标题"
                                required
                        >
                    </div>
                    <div>
                        <label for="memoTag" class="block text-sm font-medium text-gray-700 mb-2">标签 <span
                                class="text-danger">*</span></label>
                        <select
                                id="memoTag"
                                class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                                required
                        >
                            <option value="">请选择标签</option>
                            <option value="work">工作</option>
                            <option value="life">生活</option>
                            <option value="study">学习</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="memoContent" class="block text-sm font-medium text-gray-700 mb-2">内容 <span
                            class="text-danger">*</span></label>
                    <textarea
                            id="memoContent"
                            rows="6"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-y"
                            placeholder="请输入备忘录详细内容..."
                            required
                    ></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelFormBtn"
                            class="px-6 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition-all duration-300">
                        取消
                    </button>
                    <button type="submit"
                            class="px-6 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg transition-all duration-300">
                        <i id="formBtnIcon" class="fa fa-plus mr-2"></i>
                        <span id="formBtnText">创建</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- 备忘录列表统计 -->
        <div class="mx-6 my-4 flex justify-between items-center text-gray-600 text-sm">
            <span id="memoCount">共 <span class="text-primary font-bold">0</span> 条备忘录</span>
            <span id="currentTag"
                  class="bg-primary/10 text-primary px-3 py-1 rounded-full text-xs">当前：全部备忘录</span>
        </div>

        <!-- 备忘录列表 -->
        <div id="memoList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mx-6 mb-8">
            <!-- 空状态提示 -->
            <div id="emptyState" class="col-span-full flex flex-col items-center justify-center py-16 text-gray-500">
                <i class="fa fa-folder-open-o text-6xl mb-4"></i>
                <h3 class="text-xl mb-2">暂无备忘录</h3>
                <p class="mb-6">点击顶部「新增」按钮创建你的第一条记录吧</p>
                <button id="emptyAddBtn"
                        class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all duration-300">
                    <i class="fa fa-plus mr-2"></i>新增备忘录
                </button>
            </div>
        </div>
    </main>

    <!-- 操作提示 Toast -->
    <div id="toast"
         class="fixed bottom-8 right-8 px-6 py-3 rounded-lg text-white shadow-lg transform translate-y-20 opacity-0 transition-all duration-500 z-50 hidden"></div>

</main>

<th:block th:replace="~{layout/base :: footer}"></th:block>

<th:block>
    <script>
        function mockMemo() {
            fetch('[[@{/memo/mock}]]', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json; charset=utf-8',
                },
                body: JSON.stringify({
                    title: 'mockMemo'
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`请求失败：${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // 处理成功返回的数据
                    console.log("接口返回结果：", data);
                    alert("调用成功！返回数据：" + JSON.stringify(data));
                })
                .catch(error => {
                    console.error("请求异常：", error);
                    alert("调用失败：" + error.message);
                });
        }

        // 全局变量
        let memoList = [];
        let currentMemoId = null; // 当前操作的备忘录ID
        let currentActiveTag = 'all'; // 当前激活的标签

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 从localStorage加载数据
            loadMemosFromLocalStorage();
            // 更新标签统计
            updateTagCount();
            // 渲染备忘录列表
            renderMemoList();
            // 绑定所有事件
            bindAllEvents();
        });

        // 1. 数据操作 - 从localStorage加载备忘录
        function loadMemosFromLocalStorage() {
            const storedMemos = localStorage.getItem('memos');
            if (storedMemos) {
                memoList = JSON.parse(storedMemos);
            } else {
                memoList = [];
            }
        }

        // 2. 数据操作 - 保存备忘录到localStorage
        function saveMemosToLocalStorage() {
            localStorage.setItem('memos', JSON.stringify(memoList));
            updateTagCount(); // 保存后更新标签统计
        }

        // 3. 数据操作 - 生成唯一ID
        function generateUniqueId() {
            return Date.now() + Math.floor(Math.random() * 1000);
        }

        // 4. 数据操作 - 格式化时间
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 5. 数据操作 - 更新标签统计数量
        function updateTagCount() {
            // 统计各标签数量
            const tagCount = {
                all: memoList.length,
                work: memoList.filter(memo => memo.tag === 'work').length,
                life: memoList.filter(memo => memo.tag === 'life').length,
                study: memoList.filter(memo => memo.tag === 'study').length,
                other: memoList.filter(memo => memo.tag === 'other').length
            };

            // 更新页面显示
            document.getElementById('allTagCount').textContent = tagCount.all;
            Object.keys(tagCount).forEach(tag => {
                if (tag !== 'all') {
                    const el = document.querySelector(`[data-tag-count="${tag}"]`);
                    if (el) el.textContent = tagCount[tag];
                }
            });
        }

        // 6. 渲染 - 渲染备忘录列表
        function renderMemoList(filteredMemos = null) {
            const memoListEl = document.getElementById('memoList');
            const emptyStateEl = document.getElementById('emptyState');
            const memoCountEl = document.getElementById('memoCount');
            const currentTagEl = document.getElementById('currentTag');

            // 确定要渲染的数据
            const memosToRender = filteredMemos || getMemosByTag(currentActiveTag);

            // 更新统计数量和当前标签
            memoCountEl.innerHTML = `共 <span class="text-primary font-bold">${memosToRender.length}</span> 条备忘录`;
            const tagTextMap = {
                all: '全部备忘录',
                work: '工作',
                life: '生活',
                study: '学习',
                other: '其他'
            };
            currentTagEl.textContent = `当前：${tagTextMap[currentActiveTag]}`;

            // 清空列表
            memoListEl.innerHTML = '';

            // 空状态处理
            if (memosToRender.length === 0) {
                memoListEl.appendChild(emptyStateEl);
                emptyStateEl.classList.remove('hidden');
                return;
            } else {
                emptyStateEl.classList.add('hidden');
            }

            // 渲染备忘录卡片
            memosToRender.forEach(memo => {
                const memoCard = document.createElement('div');
                // 标签样式映射
                const tagStyleMap = {
                    work: 'bg-tag-1 text-tagText-1',
                    life: 'bg-tag-2 text-tagText-2',
                    study: 'bg-tag-3 text-tagText-3',
                    other: 'bg-tag-4 text-tagText-4'
                };
                const tagClass = tagStyleMap[memo.tag] || 'bg-gray-100 text-gray-600';

                memoCard.className = 'bg-white rounded-lg card-shadow hover:shadow-lg transition-all duration-300 overflow-hidden';
                memoCard.dataset.id = memo.id;

                // 计算内容预览（截取前100个字符）
                const contentPreview = memo.content.length > 100
                    ? memo.content.substring(0, 100) + '...'
                    : memo.content;

                memoCard.innerHTML = `
                    <div class="p-5">
                        <!-- 标签 -->
                        <div class="inline-block ${tagClass} px-2 py-1 rounded text-xs mb-3">
                            ${tagTextMap[memo.tag]}
                        </div>
                        <!-- 标题 -->
                        <h3 class="text-lg font-bold text-dark mb-2 truncate" title="${memo.title}">${memo.title}</h3>
                        <!-- 内容预览 -->
                        <p class="text-gray-600 mb-4 line-clamp-3" title="${memo.content}">${contentPreview}</p>
                        <!-- 时间 -->
                        <div class="flex justify-between text-xs text-gray-500 mb-4">
                            <span><i class="fa fa-calendar-plus-o mr-1"></i>创建：${formatDate(memo.createTime)}</span>
                            <span><i class="fa fa-calendar-check-o mr-1"></i>更新：${formatDate(memo.updateTime)}</span>
                        </div>
                        <!-- 操作按钮 -->
                        <div class="flex gap-2">
                            <button class="view-memo-btn w-1/2 py-2 bg-secondary/10 hover:bg-secondary/20 text-secondary rounded-lg transition-all duration-300 text-sm">
                                <i class="fa fa-eye mr-1"></i>查看（新页面）
                            </button>
                            <button class="edit-memo-btn w-1/4 py-2 bg-primary/10 hover:bg-primary/20 text-primary rounded-lg transition-all duration-300 text-sm">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="delete-memo-btn w-1/4 py-2 bg-danger/10 hover:bg-danger/20 text-danger rounded-lg transition-all duration-300 text-sm">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;

                memoListEl.appendChild(memoCard);
            });
        }

        // 7. 业务 - 根据标签筛选备忘录
        function getMemosByTag(tag) {
            if (tag === 'all') {
                return [...memoList];
            }
            return memoList.filter(memo => memo.tag === tag);
        }

        // 8. 业务 - 切换激活标签
        function switchActiveTag(tag) {
            // 更新激活状态样式
            document.querySelectorAll('.tag-btn').forEach(btn => {
                btn.classList.remove('bg-primary/10', 'text-primary', 'font-medium');
                btn.classList.add('hover:bg-gray-50');
                if (btn.dataset.tag === tag) {
                    btn.classList.remove('hover:bg-gray-50');
                    btn.classList.add('bg-primary/10', 'text-primary', 'font-medium');
                }
            });

            // 更新当前标签并渲染列表
            currentActiveTag = tag;
            const searchKeyword = document.getElementById('searchInput').value.trim().toLowerCase();
            if (searchKeyword) {
                searchMemos(); // 有搜索关键词时，同时应用标签筛选和搜索
            } else {
                renderMemoList();
            }
        }

        // 9. 业务 - 显示新增/编辑表单
        function showMemoForm(isEdit = false, memo = null) {
            const formContainer = document.getElementById('memoFormContainer');
            const formTitle = document.getElementById('formTitle');
            const formBtnIcon = document.getElementById('formBtnIcon');
            const formBtnText = document.getElementById('formBtnText');
            const memoForm = document.getElementById('memoForm');

            // 重置表单
            memoForm.reset();
            document.getElementById('memoId').value = '';

            // 区分新增/编辑
            if (isEdit && memo) {
                formTitle.textContent = '编辑备忘录';
                formBtnIcon.className = 'fa fa-pencil mr-2';
                formBtnText.textContent = '更新';
                document.getElementById('memoId').value = memo.id;
                document.getElementById('memoTitle').value = memo.title;
                document.getElementById('memoTag').value = memo.tag;
                document.getElementById('memoContent').value = memo.content;
                currentMemoId = memo.id;
            } else {
                formTitle.textContent = '新增备忘录';
                formBtnIcon.className = 'fa fa-plus mr-2';
                formBtnText.textContent = '创建';
                currentMemoId = null;
            }

            // 显示表单
            formContainer.classList.remove('hidden');
            // 滚动到表单位置
            formContainer.scrollIntoView({behavior: 'smooth', block: 'start'});
            // 聚焦标题输入框
            document.getElementById('memoTitle').focus();
        }

        // 10. 业务 - 隐藏新增/编辑表单
        function hideMemoForm() {
            const formContainer = document.getElementById('memoFormContainer');
            formContainer.classList.add('hidden');
            currentMemoId = null;
        }

        // 11. 业务 - 新增/更新备忘录
        function saveMemo(e) {
            e.preventDefault();

            const memoId = document.getElementById('memoId').value;
            const title = document.getElementById('memoTitle').value.trim();
            const tag = document.getElementById('memoTag').value;
            const content = document.getElementById('memoContent').value.trim();

            // 表单校验
            if (!title || !tag || !content) {
                showToast('标题、标签和内容不能为空', false);
                return;
            }

            if (memoId) {
                // 更新现有备忘录
                const index = memoList.findIndex(item => item.id == memoId);
                if (index !== -1) {
                    memoList[index] = {
                        ...memoList[index],
                        title,
                        tag,
                        content,
                        updateTime: Date.now()
                    };
                    saveMemosToLocalStorage();
                    renderMemoList();
                    hideMemoForm();
                    showToast('备忘录更新成功');
                }
            } else {
                // 新增备忘录
                const newMemo = {
                    id: generateUniqueId(),
                    title,
                    tag,
                    content,
                    createTime: Date.now(),
                    updateTime: Date.now()
                };
                memoList.unshift(newMemo); // 插入到列表头部
                saveMemosToLocalStorage();
                renderMemoList();
                hideMemoForm();
                showToast('备忘录创建成功');
            }
        }

        // 12. 业务 - 删除备忘录
        function deleteMemo(memoId) {
            if (!memoId) return;

            // 确认删除（原生确认框，无弹窗）
            const isConfirm = confirm('你确定要删除这条备忘录吗？删除后将无法恢复。');
            if (!isConfirm) return;

            // 过滤掉要删除的备忘录
            memoList = memoList.filter(item => item.id != memoId);
            saveMemosToLocalStorage();
            renderMemoList();
            showToast('备忘录删除成功');
        }

        // 13. 业务 - 跳转至详情页面（新页面）
        function goToDetailPage(memoId) {
            if (!memoId) return;
            // 拼接URL参数，跳转至详情页
            window.open(`memo-detail.html?id=${memoId}`, '_blank'); // 新标签页打开
            // 若需在当前标签页跳转，使用：window.location.href = `memo-detail.html?id=${memoId}`;
        }

        // 14. 业务 - 搜索备忘录（结合标签筛选）
        function searchMemos() {
            const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
            // 先按标签筛选
            const tagFilteredMemos = getMemosByTag(currentActiveTag);

            if (!keyword) {
                renderMemoList(tagFilteredMemos);
                return;
            }

            // 再按标题和内容模糊查询
            const filteredMemos = tagFilteredMemos.filter(memo =>
                memo.title.toLowerCase().includes(keyword) ||
                memo.content.toLowerCase().includes(keyword)
            );

            renderMemoList(filteredMemos);
        }

        // 15. 提示 - 显示操作结果 Toast
        function showToast(message, isSuccess = true) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'fixed bottom-8 right-8 px-6 py-3 rounded-lg text-white shadow-lg transform transition-all duration-500 z-50';
            toast.classList.add(isSuccess ? 'bg-success' : 'bg-danger');

            // 显示Toast
            toast.classList.remove('translate-y-20', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');

            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 500);
            }, 3000);
        }

        // 16. 绑定所有事件监听
        function bindAllEvents() {
            // 新增备忘录按钮
            document.getElementById('addMemoBtn').addEventListener('click', () => showMemoForm());
            document.getElementById('emptyAddBtn').addEventListener('click', () => showMemoForm());

            // 表单相关事件
            document.getElementById('cancelFormBtn').addEventListener('click', hideMemoForm);
            document.getElementById('memoForm').addEventListener('submit', saveMemo);

            // 搜索相关事件
            document.getElementById('searchInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') searchMemos();
            });
            document.getElementById('resetBtn').addEventListener('click', () => {
                document.getElementById('searchInput').value = '';
                switchActiveTag('all'); // 重置为全部标签
                renderMemoList();
            });

            // 标签切换事件
            document.querySelectorAll('.tag-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchActiveTag(btn.dataset.tag);
                });
            });

            // 备忘录列表操作（事件委托）
            document.getElementById('memoList').addEventListener('click', (e) => {
                const target = e.target;
                const memoCard = target.closest('[data-id]');
                if (!memoCard) return;

                const memoId = memoCard.dataset.id;
                const memo = memoList.find(item => item.id == memoId);

                // 查看备忘录（跳转新页面）
                if (target.closest('.view-memo-btn')) {
                    goToDetailPage(memoId);
                }

                // 编辑备忘录
                if (target.closest('.edit-memo-btn')) {
                    showMemoForm(true, memo);
                }

                // 删除备忘录
                if (target.closest('.delete-memo-btn')) {
                    deleteMemo(memoId);
                }
            });
        }
    </script>
</th:block>

</body>
</html>
