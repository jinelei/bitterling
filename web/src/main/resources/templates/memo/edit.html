<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="编辑备忘录"></title>
    <link rel="icon" th:href="@{/favicon.ico}" type="image/x-icon">
    <script th:src="@{/js/tailwind.min.js}"></script>
    <script th:src="@{/js/root.js}"></script>
    <link th:href="@{/css/root.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/light.css" />
    <script type="module"
            src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/shoelace-autoloader.js"></script>
</head>

<body class="min-h-screen flex flex-col items-center justify-center">

    <div class="w-full">
        <th:block th:replace="~{layout/base :: navbar('memo')}"></th:block>
    </div>

    <main class="flex-grow mx-auto flex flex-col items-center justify-start">
        <form id="form" th:with="updateUrl=@{/memo/update}, createUrl=@{/memo/create}"
            th:action="${memo.id != null ? updateUrl : createUrl}" method="post"
            class="space-y-1 lg:w-[70vw] w-[90vw] h-full flex flex-col items-center justify-start rounded p-3 lg:p-4 flex flex-row items-center">
            <div class="flex flex-row hidden">
                <input type="text" id="id" name="id" th:value="${memo != null ? memo.id : ''}"
                    class="w-full px-3 py-2 border-0 border-0 focus:ring-0 focus:outline-none transition duration-200"
                    placeholder="id">
            </div>
            <div class="flex flex-row lg:w-[70vw] w-[90vw] items-center justify-center">
                <input type="text" id="title" name="title" th:value="${memo != null ? memo.title : ''}"
                    class="w-full px-3 py-2 border-0 focus:ring-0 focus:outline-none transition duration-200 text-4xl font-bold text-gray-800"
                    placeholder="请输入备忘录标题">
            </div>
            <div class="flex flex-row lg:w-[70vw] w-[90vw] items-center justify-center">
                <input type="text" id="subTitle" name="subTitle" th:value="${memo != null ? memo.subTitle : ''}"
                    class="w-full px-3 py-2 border-0 focus:ring-0 focus:outline-none transition duration-200 text-1xl font-bold text-gray-500"
                    placeholder="请输入备忘录副标题">
            </div>
            <div class="flex flex-row lg:w-[70vw] w-[90vw] items-center justify-between">
                <div class="flex-grow-2 flex flex-row items-center justify-start">
                    <input type="hidden" id="tagIds" name="tagIds" th:value="${memo.tagIds}">
                    <div id="tagContainer" class="flex flex-wrap gap-2 py-2">
                        <span th:each="singleTag : ${tagList}" th:value="${singleTag.id}" th:text="${singleTag.title}"
                            th:attr="data-value=${singleTag.id}"
                            th:class="'tag-item inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium cursor-pointer transition-all duration-200 bg-gray text-black hover:bg-primary/90 ' + ${memo != null and not #lists.isEmpty(memo.tagIds) and #lists.contains(memo.tagIds, singleTag.id) ? 'bg-primary/90 text-white' : 'bg-primary/10'}">
                            默认标签
                        </span>
                    </div>
                </div>
                <div class="flex flex-row lg:w-[70vw] w-[90vw] items-center justify-center hidden">
                    <input type="number" id="orderNumber" name="orderNumber"
                        th:value="${memo != null ? memo.orderNumber : '0'}"
                        class="w-full px-3 py-2 border-0 focus:ring-0 focus:outline-none transition duration-200"
                        placeholder="请输入排序值">
                </div>
            </div>
            <div class="flex flex-row lg:w-[70vw] w-[90vw] h-[60vh] items-center justify-center flex-1">
                <textarea id="content" name="content" rows="8" th:value="${memo.content}" th:inline="text"
                    class="resize-none w-full px-3 py-2 mt-5 border-0 focus:ring-0 focus:outline-none transition duration-200 transition-height duration-100 ease-in-out box-border min-h-[50vh] overflow-hidden !overflow-y-hidden [scrollbar-width:none] [-ms-overflow-style:none]"
                    placeholder="请输入备忘录详细内容，支持换行输入...">[[${memo.content}]]</textarea>
            </div>
            <div class="lg:w-[70vw] w-[90vw] flex justify-end space-x-4 pt-2">
                <sl-button th:href="@{/memo}" variant="default">取消</sl-button>
                <sl-button type="submit" variant="primary">保存</sl-button>
            </div>
        </form>

        <th:block th:replace="~{layout/base :: footer}"></th:block>
    </main>

    <th:block>
        <script>
            const tagContainer = document.getElementById('tagContainer');
            const tagIds = document.getElementById('tagIds');

            let selectedTagValues = new Set(JSON.parse(tagIds.value));

            function initTagEvents() {
                const tagItems = document.querySelectorAll('.tag-item');

                tagItems.forEach(tag => {
                    tag.addEventListener('click', function () {
                        const value = parseInt(this.dataset.value);
                        const text = this.textContent.trim();

                        if (selectedTagValues.has(value)) {
                            selectedTagValues.delete(value);
                            this.classList.remove('bg-primary/90', 'text-white');
                            this.classList.add('bg-primary/10', 'text-black');
                        } else {
                            selectedTagValues.add(value);
                            this.classList.remove('bg-primary/10', 'text-black');
                            this.classList.add('bg-primary/90', 'text-white');
                        }

                        updateHiddenInputValue();
                    });
                });
                updateHiddenInputValue();
            }

            function updateHiddenInputValue() {
                const valuesArray = Array.from(selectedTagValues);
                tagIds.value = valuesArray;
            }

            const getExactHeight = (el) => {
                const style = window.getComputedStyle(el);
                const paddingTop = parseFloat(style.paddingTop) || 0;
                const paddingBottom = parseFloat(style.paddingBottom) || 0;
                const borderTop = parseFloat(style.borderTopWidth) || 0;
                const borderBottom = parseFloat(style.borderBottomWidth) || 0;
                const offset = paddingTop + paddingBottom + borderTop + borderBottom;
                el.style.height = 'auto';
                const contentHeight = el.scrollHeight - offset + 10;
                return Math.max(contentHeight, parseFloat(style.minHeight) || 40) + 'px';
            };

            const autoAdaptHeight = () => {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const textarea = document.getElementById('content');
                textarea.style.height = getExactHeight(textarea);
                window.scrollTo(0, scrollTop);
            };

            document.addEventListener('DOMContentLoaded', () => {
                initTagEvents();
                autoAdaptHeight();

                const textarea = document.getElementById('content');
                textarea.addEventListener('input', autoAdaptHeight);
                textarea.addEventListener('paste', autoAdaptHeight);
                textarea.addEventListener('focus', autoAdaptHeight);
                textarea.addEventListener('keydown', (e) => {
                    if (['Enter', 'Backspace', 'Delete'].includes(e.key)) {
                        setTimeout(autoAdaptHeight, 0);
                    }
                });
            });
            window.addEventListener('resize', autoAdaptHeight);
        </script>
    </th:block>

</body>

</html>